name: Build and Expose with ngrok

on:
  workflow_dispatch:
  # The workflow_dispatch event allows you to manually trigger the workflow
  # from the Actions tab in your repository. This is ideal for one-off debugging.

jobs:
  expose_server:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install

      - name: Build the web-stremio app
        run: npm run build

      # Start a simple web server to serve the build files
      - name: Start web server
        run: |
          npm install -g serve
          serve -l 3000 build &
        # The '&' runs the command in the background

      - name: Set up ngrok tunnel
        uses: luisboto/ngrok-tunnel-action@v1.0.0
        with:
          port: 3000
          ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}
          timeout: 5m
      
      - name: Wait for a few minutes
        run: sleep 300
        # The workflow will run for 5 minutes, giving you time to connect.
        # This is a temporary solution for debugging purposes.
