name: Host Stremio Server with Link

on:
  workflow_dispatch:

jobs:
  host:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and Run Stremio Server
        run: |
          echo "Installing Stremio Server CLI..."
          npm install -g @stremio/server-cli
          
          echo "Starting Stremio Server in the background..."
          # Run in background and redirect all output to a log file
          stremio-server > stremio.log 2>&1 &
          
      - name: Wait for Server and Check Logs
        run: |
          echo "Waiting 10 seconds for the server to initialize..."
          sleep 10
          echo "--- Displaying Stremio Server Logs ---"
          cat stremio.log
          
      - name: Expose Stremio Server with ngrok
        uses: ngrok/ngrok-agent-action@v1
        # Add an ID to this step so we can reference its output
        id: ngrok
        with:
          args: http 11470
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
          
      - name: ðŸ”— Create Link in Job Summary
        run: |
          echo "### Stremio Server is Live! âœ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Your Streaming Server URL is:**" >> $GITHUB_STEP_SUMMARY
          echo "[${{ steps.ngrok.outputs.url }}](${{ steps.ngrok.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Copy this URL and paste it into your Stremio app's streaming settings.*" >> $GITHUB_STEP_SUMMARY
          echo "*This server will remain active for up to 6 hours or until you cancel it.*" >> $GITHUB_STEP_SUMMARY
      
      - name: Keep Runner Alive
        # This step ensures the workflow doesn't exit, keeping the server online.
        run: tail -f /dev/null
