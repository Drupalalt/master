name: socks5-ngrok-no-auth
on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # keep alive up to 6h
    steps:
      - name: Install microsocks and tools
        run: |
          sudo apt-get update
          sudo apt-get install -y microsocks jq

      - name: Start microsocks (SOCKS5 on 127.0.0.1:1080, no auth)
        run: |
          # Bind to loopback; tunnel will be the only ingress
          nohup microsocks -i 127.0.0.1 -p 1080 > microsocks.log 2>&1 &
          sleep 2
          ss -lntp || true

      - name: Start ngrok TCP tunnel to port 1080
        uses: luisboto/ngrok-tunnel-action@v3
        with:
          timeout: 6h
          port: 1080
          tunnel_type: tcp
          ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}
          save_url_to_filename: tunnel_url.txt

      - name: Show connection info
        id: info
        run: |
          TUNNEL_URL="$(cat tunnel_url.txt)"
          echo "tunnel_url=$TUNNEL_URL" >> "$GITHUB_OUTPUT"
          echo "SOCKS5 endpoint (no auth): $TUNNEL_URL"

      - name: Keep job alive
        run: sleep 6h
